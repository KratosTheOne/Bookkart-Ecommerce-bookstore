"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function getChunkedStream(source) {
    var sourceReader = source.getReader();
    var currentMessageTotalLength = 0;
    var currentMessagePendingLength = 0;
    var currentMessage = null;
    var messageLengthBuffer = null;
    var allocateMessage = function (size) {
        if (typeof size !== "number") {
            throw new Error("Attempted to allocate an event message where size was not a number: " +
                size);
        }
        currentMessageTotalLength = size;
        currentMessagePendingLength = 4;
        currentMessage = new Uint8Array(size);
        var currentMessageView = new DataView(currentMessage.buffer);
        currentMessageView.setUint32(0, size, false); //set big-endian Uint32 to 0~3 bytes
    };
    var chunkedStream = new ReadableStream({
        start: function (controller) {
            function push() {
                return sourceReader.read().then(function (_a) {
                    var done = _a.done, value = _a.value;
                    if (done) {
                        if (currentMessageTotalLength) {
                            if (currentMessageTotalLength === currentMessagePendingLength) {
                                controller.enqueue(currentMessage);
                            }
                            else {
                                throw new Error("Truncated event message received.");
                            }
                        }
                        controller.close();
                        return;
                    }
                    // @ts-ignore error TS2532: Object is possibly 'undefined' for value
                    var chunkLength = value.length;
                    var currentOffset = 0;
                    while (currentOffset < chunkLength) {
                        // create new message if necessary
                        if (!currentMessage) {
                            // working on a new message, determine total length
                            var bytesRemaining = chunkLength - currentOffset;
                            // prevent edge case where total length spans 2 chunks
                            if (!messageLengthBuffer) {
                                messageLengthBuffer = new Uint8Array(4);
                            }
                            var numBytesForTotal = Math.min(4 - currentMessagePendingLength, // remaining bytes to fill the messageLengthBuffer
                            bytesRemaining // bytes left in chunk
                            );
                            messageLengthBuffer.set(
                            // @ts-ignore error TS2532: Object is possibly 'undefined' for value
                            value.slice(currentOffset, currentOffset + numBytesForTotal), currentMessagePendingLength);
                            currentMessagePendingLength += numBytesForTotal;
                            currentOffset += numBytesForTotal;
                            if (currentMessagePendingLength < 4) {
                                // not enough information to create the current message
                                break;
                            }
                            allocateMessage(new DataView(messageLengthBuffer.buffer).getUint32(0, false));
                            messageLengthBuffer = null;
                        }
                        // write data into current message
                        var numBytesToWrite = Math.min(currentMessageTotalLength - currentMessagePendingLength, // number of bytes left to complete message
                        chunkLength - currentOffset // number of bytes left in the original chunk
                        );
                        currentMessage.set(
                        // @ts-ignore error TS2532: Object is possibly 'undefined' for value
                        value.slice(currentOffset, currentOffset + numBytesToWrite), currentMessagePendingLength);
                        currentMessagePendingLength += numBytesToWrite;
                        currentOffset += numBytesToWrite;
                        // check if a message is ready to be pushed
                        if (currentMessageTotalLength &&
                            currentMessageTotalLength === currentMessagePendingLength) {
                            // push out the message
                            controller.enqueue(currentMessage);
                            // cleanup
                            currentMessage = null;
                            currentMessageTotalLength = 0;
                            currentMessagePendingLength = 0;
                        }
                    }
                    push();
                });
            }
            push();
        }
    });
    return chunkedStream;
}
exports.getChunkedStream = getChunkedStream;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0Q2h1bmtlZFN0cmVhbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9nZXRDaHVua2VkU3RyZWFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsU0FBZ0IsZ0JBQWdCLENBQzlCLE1BQWtDO0lBRWxDLElBQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN4QyxJQUFJLHlCQUF5QixHQUFHLENBQUMsQ0FBQztJQUNsQyxJQUFJLDJCQUEyQixHQUFHLENBQUMsQ0FBQztJQUNwQyxJQUFJLGNBQWMsR0FBc0IsSUFBSSxDQUFDO0lBQzdDLElBQUksbUJBQW1CLEdBQXNCLElBQUksQ0FBQztJQUNsRCxJQUFNLGVBQWUsR0FBRyxVQUFVLElBQVk7UUFDNUMsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7WUFDNUIsTUFBTSxJQUFJLEtBQUssQ0FDYixzRUFBc0U7Z0JBQ3BFLElBQUksQ0FDUCxDQUFDO1NBQ0g7UUFDRCx5QkFBeUIsR0FBRyxJQUFJLENBQUM7UUFDakMsMkJBQTJCLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLGNBQWMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxJQUFNLGtCQUFrQixHQUFHLElBQUksUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvRCxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLG9DQUFvQztJQUNwRixDQUFDLENBQUM7SUFFRixJQUFNLGFBQWEsR0FBRyxJQUFJLGNBQWMsQ0FBQztRQUN2QyxLQUFLLEVBQUwsVUFBTSxVQUFVO1lBQ2QsU0FBUyxJQUFJO2dCQUNYLE9BQU8sWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEVBQWU7d0JBQWIsY0FBSSxFQUFFLGdCQUFLO29CQUM1QyxJQUFJLElBQUksRUFBRTt3QkFDUixJQUFJLHlCQUF5QixFQUFFOzRCQUM3QixJQUFJLHlCQUF5QixLQUFLLDJCQUEyQixFQUFFO2dDQUM3RCxVQUFVLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOzZCQUNwQztpQ0FBTTtnQ0FDTCxNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7NkJBQ3REO3lCQUNGO3dCQUNELFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQzt3QkFDbkIsT0FBTztxQkFDUjtvQkFFRCxvRUFBb0U7b0JBQ3BFLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7b0JBQ2pDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztvQkFFdEIsT0FBTyxhQUFhLEdBQUcsV0FBVyxFQUFFO3dCQUNsQyxrQ0FBa0M7d0JBQ2xDLElBQUksQ0FBQyxjQUFjLEVBQUU7NEJBQ25CLG1EQUFtRDs0QkFDbkQsSUFBTSxjQUFjLEdBQUcsV0FBVyxHQUFHLGFBQWEsQ0FBQzs0QkFDbkQsc0RBQXNEOzRCQUN0RCxJQUFJLENBQUMsbUJBQW1CLEVBQUU7Z0NBQ3hCLG1CQUFtQixHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDOzZCQUN6Qzs0QkFDRCxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQy9CLENBQUMsR0FBRywyQkFBMkIsRUFBRSxrREFBa0Q7NEJBQ25GLGNBQWMsQ0FBQyxzQkFBc0I7NkJBQ3RDLENBQUM7NEJBRUYsbUJBQW1CLENBQUMsR0FBRzs0QkFDckIsb0VBQW9FOzRCQUNwRSxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxhQUFhLEdBQUcsZ0JBQWdCLENBQUMsRUFDNUQsMkJBQTJCLENBQzVCLENBQUM7NEJBRUYsMkJBQTJCLElBQUksZ0JBQWdCLENBQUM7NEJBQ2hELGFBQWEsSUFBSSxnQkFBZ0IsQ0FBQzs0QkFFbEMsSUFBSSwyQkFBMkIsR0FBRyxDQUFDLEVBQUU7Z0NBQ25DLHVEQUF1RDtnQ0FDdkQsTUFBTTs2QkFDUDs0QkFDRCxlQUFlLENBQ2IsSUFBSSxRQUFRLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FDN0QsQ0FBQzs0QkFDRixtQkFBbUIsR0FBRyxJQUFJLENBQUM7eUJBQzVCO3dCQUVELGtDQUFrQzt3QkFDbEMsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FDOUIseUJBQXlCLEdBQUcsMkJBQTJCLEVBQUUsMkNBQTJDO3dCQUNwRyxXQUFXLEdBQUcsYUFBYSxDQUFDLDZDQUE2Qzt5QkFDMUUsQ0FBQzt3QkFDRixjQUFlLENBQUMsR0FBRzt3QkFDakIsb0VBQW9FO3dCQUNwRSxLQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxhQUFhLEdBQUcsZUFBZSxDQUFDLEVBQzNELDJCQUEyQixDQUM1QixDQUFDO3dCQUNGLDJCQUEyQixJQUFJLGVBQWUsQ0FBQzt3QkFDL0MsYUFBYSxJQUFJLGVBQWUsQ0FBQzt3QkFFakMsMkNBQTJDO3dCQUMzQyxJQUNFLHlCQUF5Qjs0QkFDekIseUJBQXlCLEtBQUssMkJBQTJCLEVBQ3pEOzRCQUNBLHVCQUF1Qjs0QkFDdkIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQzs0QkFDbkMsVUFBVTs0QkFDVixjQUFjLEdBQUcsSUFBSSxDQUFDOzRCQUN0Qix5QkFBeUIsR0FBRyxDQUFDLENBQUM7NEJBQzlCLDJCQUEyQixHQUFHLENBQUMsQ0FBQzt5QkFDakM7cUJBQ0Y7b0JBQ0QsSUFBSSxFQUFFLENBQUM7Z0JBQ1QsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBSSxFQUFFLENBQUM7UUFDVCxDQUFDO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsT0FBTyxhQUFhLENBQUM7QUFDdkIsQ0FBQztBQTlHRCw0Q0E4R0MiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZnVuY3Rpb24gZ2V0Q2h1bmtlZFN0cmVhbShcbiAgc291cmNlOiBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5PlxuKTogUmVhZGFibGVTdHJlYW08VWludDhBcnJheT4ge1xuICBjb25zdCBzb3VyY2VSZWFkZXIgPSBzb3VyY2UuZ2V0UmVhZGVyKCk7XG4gIGxldCBjdXJyZW50TWVzc2FnZVRvdGFsTGVuZ3RoID0gMDtcbiAgbGV0IGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aCA9IDA7XG4gIGxldCBjdXJyZW50TWVzc2FnZTogVWludDhBcnJheSB8IG51bGwgPSBudWxsO1xuICBsZXQgbWVzc2FnZUxlbmd0aEJ1ZmZlcjogVWludDhBcnJheSB8IG51bGwgPSBudWxsO1xuICBjb25zdCBhbGxvY2F0ZU1lc3NhZ2UgPSBmdW5jdGlvbiAoc2l6ZTogbnVtYmVyKSB7XG4gICAgaWYgKHR5cGVvZiBzaXplICE9PSBcIm51bWJlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiQXR0ZW1wdGVkIHRvIGFsbG9jYXRlIGFuIGV2ZW50IG1lc3NhZ2Ugd2hlcmUgc2l6ZSB3YXMgbm90IGEgbnVtYmVyOiBcIiArXG4gICAgICAgICAgc2l6ZVxuICAgICAgKTtcbiAgICB9XG4gICAgY3VycmVudE1lc3NhZ2VUb3RhbExlbmd0aCA9IHNpemU7XG4gICAgY3VycmVudE1lc3NhZ2VQZW5kaW5nTGVuZ3RoID0gNDtcbiAgICBjdXJyZW50TWVzc2FnZSA9IG5ldyBVaW50OEFycmF5KHNpemUpO1xuICAgIGNvbnN0IGN1cnJlbnRNZXNzYWdlVmlldyA9IG5ldyBEYXRhVmlldyhjdXJyZW50TWVzc2FnZS5idWZmZXIpO1xuICAgIGN1cnJlbnRNZXNzYWdlVmlldy5zZXRVaW50MzIoMCwgc2l6ZSwgZmFsc2UpOyAvL3NldCBiaWctZW5kaWFuIFVpbnQzMiB0byAwfjMgYnl0ZXNcbiAgfTtcblxuICBjb25zdCBjaHVua2VkU3RyZWFtID0gbmV3IFJlYWRhYmxlU3RyZWFtKHtcbiAgICBzdGFydChjb250cm9sbGVyKSB7XG4gICAgICBmdW5jdGlvbiBwdXNoKCkge1xuICAgICAgICByZXR1cm4gc291cmNlUmVhZGVyLnJlYWQoKS50aGVuKCh7IGRvbmUsIHZhbHVlIH0pID0+IHtcbiAgICAgICAgICBpZiAoZG9uZSkge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRNZXNzYWdlVG90YWxMZW5ndGgpIHtcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRNZXNzYWdlVG90YWxMZW5ndGggPT09IGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aCkge1xuICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShjdXJyZW50TWVzc2FnZSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVHJ1bmNhdGVkIGV2ZW50IG1lc3NhZ2UgcmVjZWl2ZWQuXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gQHRzLWlnbm9yZSBlcnJvciBUUzI1MzI6IE9iamVjdCBpcyBwb3NzaWJseSAndW5kZWZpbmVkJyBmb3IgdmFsdWVcbiAgICAgICAgICBjb25zdCBjaHVua0xlbmd0aCA9IHZhbHVlLmxlbmd0aDtcbiAgICAgICAgICBsZXQgY3VycmVudE9mZnNldCA9IDA7XG5cbiAgICAgICAgICB3aGlsZSAoY3VycmVudE9mZnNldCA8IGNodW5rTGVuZ3RoKSB7XG4gICAgICAgICAgICAvLyBjcmVhdGUgbmV3IG1lc3NhZ2UgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgICBpZiAoIWN1cnJlbnRNZXNzYWdlKSB7XG4gICAgICAgICAgICAgIC8vIHdvcmtpbmcgb24gYSBuZXcgbWVzc2FnZSwgZGV0ZXJtaW5lIHRvdGFsIGxlbmd0aFxuICAgICAgICAgICAgICBjb25zdCBieXRlc1JlbWFpbmluZyA9IGNodW5rTGVuZ3RoIC0gY3VycmVudE9mZnNldDtcbiAgICAgICAgICAgICAgLy8gcHJldmVudCBlZGdlIGNhc2Ugd2hlcmUgdG90YWwgbGVuZ3RoIHNwYW5zIDIgY2h1bmtzXG4gICAgICAgICAgICAgIGlmICghbWVzc2FnZUxlbmd0aEJ1ZmZlcikge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2VMZW5ndGhCdWZmZXIgPSBuZXcgVWludDhBcnJheSg0KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBudW1CeXRlc0ZvclRvdGFsID0gTWF0aC5taW4oXG4gICAgICAgICAgICAgICAgNCAtIGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aCwgLy8gcmVtYWluaW5nIGJ5dGVzIHRvIGZpbGwgdGhlIG1lc3NhZ2VMZW5ndGhCdWZmZXJcbiAgICAgICAgICAgICAgICBieXRlc1JlbWFpbmluZyAvLyBieXRlcyBsZWZ0IGluIGNodW5rXG4gICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgbWVzc2FnZUxlbmd0aEJ1ZmZlci5zZXQoXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBlcnJvciBUUzI1MzI6IE9iamVjdCBpcyBwb3NzaWJseSAndW5kZWZpbmVkJyBmb3IgdmFsdWVcbiAgICAgICAgICAgICAgICB2YWx1ZS5zbGljZShjdXJyZW50T2Zmc2V0LCBjdXJyZW50T2Zmc2V0ICsgbnVtQnl0ZXNGb3JUb3RhbCksXG4gICAgICAgICAgICAgICAgY3VycmVudE1lc3NhZ2VQZW5kaW5nTGVuZ3RoXG4gICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgY3VycmVudE1lc3NhZ2VQZW5kaW5nTGVuZ3RoICs9IG51bUJ5dGVzRm9yVG90YWw7XG4gICAgICAgICAgICAgIGN1cnJlbnRPZmZzZXQgKz0gbnVtQnl0ZXNGb3JUb3RhbDtcblxuICAgICAgICAgICAgICBpZiAoY3VycmVudE1lc3NhZ2VQZW5kaW5nTGVuZ3RoIDwgNCkge1xuICAgICAgICAgICAgICAgIC8vIG5vdCBlbm91Z2ggaW5mb3JtYXRpb24gdG8gY3JlYXRlIHRoZSBjdXJyZW50IG1lc3NhZ2VcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBhbGxvY2F0ZU1lc3NhZ2UoXG4gICAgICAgICAgICAgICAgbmV3IERhdGFWaWV3KG1lc3NhZ2VMZW5ndGhCdWZmZXIuYnVmZmVyKS5nZXRVaW50MzIoMCwgZmFsc2UpXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIG1lc3NhZ2VMZW5ndGhCdWZmZXIgPSBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyB3cml0ZSBkYXRhIGludG8gY3VycmVudCBtZXNzYWdlXG4gICAgICAgICAgICBjb25zdCBudW1CeXRlc1RvV3JpdGUgPSBNYXRoLm1pbihcbiAgICAgICAgICAgICAgY3VycmVudE1lc3NhZ2VUb3RhbExlbmd0aCAtIGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aCwgLy8gbnVtYmVyIG9mIGJ5dGVzIGxlZnQgdG8gY29tcGxldGUgbWVzc2FnZVxuICAgICAgICAgICAgICBjaHVua0xlbmd0aCAtIGN1cnJlbnRPZmZzZXQgLy8gbnVtYmVyIG9mIGJ5dGVzIGxlZnQgaW4gdGhlIG9yaWdpbmFsIGNodW5rXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY3VycmVudE1lc3NhZ2UhLnNldChcbiAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSBlcnJvciBUUzI1MzI6IE9iamVjdCBpcyBwb3NzaWJseSAndW5kZWZpbmVkJyBmb3IgdmFsdWVcbiAgICAgICAgICAgICAgdmFsdWUuc2xpY2UoY3VycmVudE9mZnNldCwgY3VycmVudE9mZnNldCArIG51bUJ5dGVzVG9Xcml0ZSksXG4gICAgICAgICAgICAgIGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aCArPSBudW1CeXRlc1RvV3JpdGU7XG4gICAgICAgICAgICBjdXJyZW50T2Zmc2V0ICs9IG51bUJ5dGVzVG9Xcml0ZTtcblxuICAgICAgICAgICAgLy8gY2hlY2sgaWYgYSBtZXNzYWdlIGlzIHJlYWR5IHRvIGJlIHB1c2hlZFxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZVRvdGFsTGVuZ3RoICYmXG4gICAgICAgICAgICAgIGN1cnJlbnRNZXNzYWdlVG90YWxMZW5ndGggPT09IGN1cnJlbnRNZXNzYWdlUGVuZGluZ0xlbmd0aFxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIC8vIHB1c2ggb3V0IHRoZSBtZXNzYWdlXG4gICAgICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShjdXJyZW50TWVzc2FnZSk7XG4gICAgICAgICAgICAgIC8vIGNsZWFudXBcbiAgICAgICAgICAgICAgY3VycmVudE1lc3NhZ2UgPSBudWxsO1xuICAgICAgICAgICAgICBjdXJyZW50TWVzc2FnZVRvdGFsTGVuZ3RoID0gMDtcbiAgICAgICAgICAgICAgY3VycmVudE1lc3NhZ2VQZW5kaW5nTGVuZ3RoID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcHVzaCgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcHVzaCgpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIGNodW5rZWRTdHJlYW07XG59XG4iXX0=